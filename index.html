<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>You've Been Martined</title>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
  <h1 id="title"></h1>
  <div id="text"></div>
</body>
<script>
  var synth = window.speechSynthesis

  synth.cancel()

  function setVoice (utterance, voice = 'Daniel') {
    utterance.voice = synth.getVoices()
    .filter(function (v) {
      return v.name === voice
    })[0]

    return utterance
  }

  function speak (message, callback) {
    var utterance = new SpeechSynthesisUtterance(message)

    setVoice(utterance, 'Daniel')

    if (typeof callback === 'function') {
      callback(utterance)
    }

    synth.speak(utterance)
  }

  function getWikipediaData (callback) {
    var url = 'https://en.wikipedia.org/w/api.php'
      + '?origin=*&format=json&action=query&exlimit=max'
      + '&generator=random&grnnamespace=0&exintro=&explaintext='
      + '&prop=extracts|revisions|images&rvprop=content&grnlimit=1'

      fetch(url)
        .then(function (response) { return response.json() })
        .then(function (data) {
          var pages = data.query.pages;
          var page = pages[Object.keys(pages)[0]];
          callback(page.title, page.extract)
        })
  }

  function martin () {
    getWikipediaData(function (title, text) {
      document.getElementById('title').innerHTML = title
      document.getElementById('text').innerHTML = text

      speak(text, function (utterance) {
        utterance.onend = function (e) {
          speak('That was interesting?', function (utterance) {
            martin()
          })
        }
      })
    })
  }

  window.onload = martin
</script>
</html>
